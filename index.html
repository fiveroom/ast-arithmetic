<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AST</title>
</head>
<body>
    <script>
        const str = '1.2 + 2 + (4*4) +"123" * ROUND(2, 1)';
        //    number 正数 负数 小数  /\d/
        //    paren ( )  /[()]/
        //    sign + - * / ^  /[+-*/^]/
        //    constant 常量
        //  variable_
        //

        const NUMBER_REGEX = /\d/
        const PAREN_REGEX = /[()]/
        const SIGN_REGEX = /[+\-*/^]/

        const VARIABLE_REGEX = /["']/
        class Lexer {

            constructor() {
                this.state = this.start;
                this.tokens = [];
                this.token = '';
                this.lastMatch = '';
            }

            /**
             *
             * @param s {string}
             */
            start(s){
                if(NUMBER_REGEX.test(s)){
                    this.token = s;
                    this.type = 'number'
                    return this.inInt;
                }

                if(PAREN_REGEX.test(s)){
                    this.emitToken('paren', s)
                    return this.start;
                }

                if(SIGN_REGEX.test(s)){
                    this.emitToken('sign', s)
                    return this.start;
                }

                if(VARIABLE_REGEX.test(s)){
                    this.lastMatch = s;
                    this.token = s;
                    this.type = 'variable';
                    return this.inVariable;
                }

                if(/\s/.test(s)){
                    return this.start
                }

                if(/[a-z_$]/i.test(s)){
                    this.token = s;
                    this.type = 'charStr';
                    return this.inCharStr
                }
                if(/,/i.test(s)){
                    this.emitToken('paramSplit', s)
                    return this.start
                }
                throw Error('错误')
            }

            inInt(s){
                if(NUMBER_REGEX.test(s)){
                    this.token += s;
                    return  this.inInt;
                }

                if(/\./.test(s)){
                    this.token += s;
                    return this.inFloat;
                }

                this.emitToken('number', this.token);
                this.token = '';
                this.type = '';
                return this.start(s)
            }

            inFloat(s){
                if(NUMBER_REGEX.test(s)){
                    this.token += s;
                    return this.inFloat;
                }
                if(s === '.'){
                    throw Error('不能同时出现 1.1.1')
                }
                if(this.token[this.token.length - 1] === '.'){
                    throw Error('不能同时出现 ..')
                }

                this.emitToken('number', this.token);
                return this.start(s)
            }

            inVariable(s){
                if(s === this.lastMatch){
                    this.token += s;
                    this.emitToken('variable', this.token);
                    this.token = '';
                    this.type = ''
                    return this.start
                }
                this.token += s;
                return this.inVariable
            }

            inCharStr(s){
                if(/[a-z\d$_]/i.test(s)){
                    this.token += s;
                    return this.inCharStr
                }
                this.emitToken(this.type, this.token);
                this.type = '';
                this.token = '';
                return this.start(s)
            }

            /**
             * @param char {string}
             */
            push(char){
                this.state = this.state(char);
                return this.emit()
            }

            emitToken(type, value){
                this.tokens.push({type, value})
            }

            end(){
                if(this.token){
                    // 可以判断数字和
                    this.emitToken(this.type, this.token);
                }
                return this.emit()
            }

            emit(){
                const _token = [...this.tokens]
                this.tokens = [];
                return _token
            }

        }
        const l = new Lexer();
        const tokens = [];
        for (const s of str) {
            tokens.push(...l.push(s))
        }
        tokens.push(...l.end())
        console.log(tokens);
    </script>
</body>
</html>
